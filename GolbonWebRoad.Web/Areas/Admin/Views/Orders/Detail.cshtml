@model GolbonWebRoad.Web.Areas.Admin.Models.Orders.OrderDetailViewModel
@{
    ViewData["Title"] = "جزئیات سفارش #" + Model.Id;

    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "PaymentReceived" => "bg-success",
            "Pending" => "bg-warning text-dark",
            "Shipped" => "bg-info text-dark",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetStatusText(string status)
    {
        return status switch
        {
            "PaymentReceived" => "پرداخت دریافت شده",
            "Pending" => "در انتظار",
            "Shipped" => "ارسال شده",
            "Cancelled" => "لغو شده",
            _ => status
        };
    }
}

<!-- نمایش پیام‌های موفقیت یا خطا -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">@ViewData["Title"]</h1>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-2"></i> بازگشت به لیست سفارشات
    </a>
</div>

<div class="row g-4">
    <!-- بخش اصلی: اقلام و اطلاعات ارسال -->
    <div class="col-lg-8">
        <!-- جدول اقلام سفارش (بدون تغییر) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">اقلام سفارش</h5></div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <!-- ... محتوای جدول اقلام ... -->
                    </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-end fw-bold fs-5 p-3">
                <span>مبلغ نهایی سفارش: </span>
                <span class="me-2 text-primary">@Model.TotalAmount.ToString("N0") تومان</span>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- === بخش جدید برای مدیریت و نمایش ارسال === -->
        <!-- ============================================= -->
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0">مدیریت ارسال</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2 text-muted">روش ارسال انتخاب شده:</p>
                        <p class="fw-bold fs-5">@Model.ShippingMethod</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2 text-muted">هزینه ارسال:</p>
                        <p class="fw-bold fs-5">@Model.ShippingCost.ToString("N0") تومان</p>
                    </div>
                </div>
                <hr />

                @if (!string.IsNullOrEmpty(Model.TrackingNumber))
                {
                    <!-- اگر کد رهگیری وجود داشت، آن را نمایش بده -->
                    <div class="alert alert-success">
                        <h5 class="alert-heading">مرسوله ارسال شده است!</h5>
                        <p class="mb-0">کد رهگیری: <strong class="fs-4" style="letter-spacing: 2px;">@Model.TrackingNumber</strong></p>
                    </div>
                }
                else if (!string.IsNullOrEmpty(Model.ShippingMethod))
                {
                    <!-- اگر کد رهگیری وجود نداشت ولی روش ارسال مشخص بود، دکمه ثبت را نمایش بده -->
                    <p>این سفارش آماده ارسال است. برای ثبت مرسوله در سیستم شرکت پستی و دریافت کد رهگیری، روی دکمه زیر کلیک کنید.</p>
                    <form asp-action="CreateShipment" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="orderId" value="@Model.Id" />
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-shipping-fast me-2"></i> ثبت مرسوله و دریافت کد رهگیری
                            </button>
                        </div>
                    </form>
                }
                else
                {
                    <p class="text-muted">روش ارسالی برای این سفارش ثبت نشده است.</p>
                }
            </div>
        </div>
    </div>

    <!-- ستون کناری: اطلاعات سفارش و مشتری -->
    <div class="col-lg-4">
        <!-- اطلاعات سفارش -->
        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">اطلاعات سفارش</h5></div>
            <div class="card-body">
                <p><strong>نام کاربری:</strong> @Model.UserName</p>
                <p><strong>تاریخ ثبت:</strong> @Model.OrderDate</p>
                <p><strong>وضعیت:</strong> <span class="badge @GetStatusBadgeClass(Model.OrderStatus)">@GetStatusText(Model.OrderStatus)</span></p>
                <p><strong>مبلغ نهایی:</strong> @Model.TotalAmount.ToString("N0") تومان</p>
            </div>
        </div>

        <!-- آدرس تحویل -->
        @if (Model.UserAddress != null)
        {
            <div class="card shadow-sm mb-4">
                <div class="card-header"><h5 class="mb-0">آدرس تحویل</h5></div>
                <div class="card-body">
                    <p><strong>شماره تماس:</strong> @Model.UserAddress.Phone</p>
                    <p><strong>آدرس:</strong> @Model.UserAddress.AddressLine</p>
                    <p><strong>شهر:</strong> @Model.UserAddress.City</p>
                    <p><strong>استان:</strong> @Model.UserAddress.Province</p>
                    <p><strong>کد پستی:</strong> @Model.UserAddress.PostalCode</p>
                </div>
            </div>
        }

        <!-- تغییر وضعیت -->
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0">تغییر وضعیت</h5></div>
            <div class="card-body">
                <form asp-action="UpdateStatus" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="mb-3">
                        <select name="status" class="form-select">
                            <option value="Pending" selected="@(Model.OrderStatus == "Pending")">در انتظار</option>
                            <option value="PaymentReceived" selected="@(Model.OrderStatus == "PaymentReceived")">پرداخت دریافت شده</option>
                            <option value="Shipped" selected="@(Model.OrderStatus == "Shipped")">ارسال شده</option>
                            <option value="Cancelled" selected="@(Model.OrderStatus == "Cancelled")">لغو شده</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">اعمال تغییر</button>
                </form>
            </div>
        </div>
    </div>
</div>
